<p-toolbar styleClass="mb-6">
    <ng-template #start>
        <p-button (onClick)="newProduct()" label="New" icon="pi pi-plus" severity="secondary" class="mr-2" />
        <p-button severity="secondary" label="Delete" icon="pi pi-trash" outlined (onClick)="deleteSelectedProducts()" [disabled]="!selectedProducts || !selectedProducts.length" />
    </ng-template>

    <ng-template #end>
        <p-button label="Export" icon="pi pi-upload" severity="secondary" />
    </ng-template>
</p-toolbar>

<p-card>
    <p-table
    #dt
    [value]="products"
    [rows]="10"
    [columns]="cols"
    [loading]="loading"
    [globalFilterFields]="['basicDetails.productName']"
    [tableStyle]="{ 'min-width': '75rem' }"
    [(selection)]="selectedProducts"
    [rowHover]="true"
    dataKey="productId"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} products"
    [showCurrentPageReport]="true"
    [rowsPerPageOptions]="[10, 20, 30]">

        <ng-template #caption>
            <div class="flex items-center justify-between">
                <h5 class="m-0">Product List</h5>
                <p-iconfield>
                    <p-inputicon styleClass="pi pi-search" />
                    <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Search..." />
                </p-iconfield>
            </div>
        </ng-template>
        <ng-template #header>
            <tr>
                <th style="width: 3rem">
                    <p-tableHeaderCheckbox />
                </th>
                <th pSortableColumn="basicDetails.barcode" style="min-width:10rem">
                    {{ 'BARCODE' | translate }}
                    <p-sortIcon field="barcode" />
                </th>
                <th pSortableColumn="basicDetails.productName" style="min-width:16rem">
                    {{ 'NAME' | translate }}
                    <p-sortIcon field="productName" />
                </th>
                <th>
                    {{ 'IMAGE' | translate }}
                </th>
                <th pSortableColumn="basicDetails.productCategory.name" style="min-width: 8rem">
                    {{ 'CATEGORY' | translate }}
                    <p-sortIcon field="productBrand" />
                </th>
                <th pSortableColumn="basicDetails.productBrand?.name" style="min-width: 8rem">
                    {{ 'BRAND' | translate }}
                    <p-sortIcon field="productBrand" />
                </th>
                <th pSortableColumn="priceDetails.costPrice" style="min-width: 8rem">
                    {{ 'COST' | translate }}
                    <p-sortIcon field="costPrice" />
                </th>
                <th pSortableColumn="priceDetails.sellingPrice" style="min-width: 8rem">
                    {{ 'PRICE' | translate }}
                    <p-sortIcon field="sellingPrice" />
                </th>
                <th>
                    {{ 'DISCOUNT' | translate }}
                </th>
                <th style="min-width: 8rem">
                    {{ 'PRICE_AFTER_DISCOUNT' | translate }}
                </th>
                <th pSortableColumn="basicDetails.quantity">
                    {{ 'QUANTITY' | translate }}
                    <p-sortIcon field="quantity" />
                </th>
                <th style="min-width: 12rem"></th>
            </tr>
        </ng-template>
        <ng-template #body let-product>
            <tr>
                <td style="width: 3rem">
                    <p-tableCheckbox [value]="product" />
                </td>
                <td style="min-width: 12rem">{{ product.basicDetails.barcode }}</td>
                <td style="min-width: 16rem">{{ product.basicDetails.productName }}</td>
                <td>
                    <img class="rounded w-full"
                        [src]="getProductImageSrc(product)"
                        [alt]="product.basicDetails?.productName"
                        style="width: 80px; object-fit: cover;" />
                </td>
                <td>{{ product.basicDetails.productCategory?.name }}</td>
                <td>{{ product.basicDetails.productBrand?.name }}</td>
                <td>{{ product.priceDetails.costPrice | sCurrency }}</td>
                <td>{{ product.priceDetails.sellingPrice | sCurrency }}</td>
                <td>
                    <div class="flex items-center gap-2">
                        <div class="text-sm">
                            {{ getDiscountLabel(product) }}
                        </div>
                        <div *ngIf="product.priceDetails.discountActive">
                            <p-button pTooltip="Show discount" icon="pi pi-eye" class="mr-2" [rounded]="true" [text]="true" (onClick)="editProductDiscount(product)" />
                        </div>
                        <div *ngIf="!product.priceDetails.discountActive">
                            <p-button pTooltip="Create discount" icon="pi pi-percentage" class="mr-2" [rounded]="true" [text]="true" (onClick)="editProductDiscount(product)" />
                        </div>
                    </div>
                </td>
                <td>{{ product.priceDetails.priceWithDiscount | sCurrency }}</td>
                <td>
                    <p-tag [value]="product.basicDetails.quantity" [severity]="getQuantitySeverity(product)" />
                </td>

                <td>
                    <p-button icon="pi pi-pencil" class="mr-2" [rounded]="true" [outlined]="true" (onClick)="onEditProduct(product)" />
                    <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [outlined]="true" (click)="deleteProduct(product)" />
                </td>
            </tr>
        </ng-template>
    </p-table>
    <p-paginator
            (onPageChange)="onPageChange($event)"
            [first]="pageReq.page * pageReq.size"
            [rows]="pageReq.size"
            [totalRecords]="pageDetails?.totalElements || 0"
            [showCurrentPageReport]="true"
            [showJumpToPageDropdown]="false"
            currentPageReportTemplate="Showing {first} to {last} of {totalRecords}" />
</p-card>

<p-confirmdialog [style]="{ width: '450px' }" />

<app-product-discount-create *ngIf="discountDialog" [visible]="discountDialog" [product]="product"
(success)="discountSuccess($event)"    
(visibileChange)="discountDialogToggle($event)">
</app-product-discount-create>